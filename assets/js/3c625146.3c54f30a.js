"use strict";(self.webpackChunkzustand_zh=self.webpackChunkzustand_zh||[]).push([[2525],{7441:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"migrations/migrating-to-v5","title":"\u5982\u4f55\u4ece v4 \u8fc1\u79fb\u5230 v5","description":"\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae\u5728\u8fc1\u79fb\u5230 v5 \u4e4b\u524d\u66f4\u65b0\u5230 v4 \u7684\u6700\u65b0\u7248\u672c\u3002\u5b83\u4f1a\u663e\u793a\u6240\u6709\u5f03\u7528\u8b66\u544a\uff0c\u800c\u4e0d\u4f1a\u7834\u574f\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u3002","source":"@site/docs/migrations/migrating-to-v5.md","sourceDirName":"migrations","slug":"/migrations/migrating-to-v5","permalink":"/zustand-zh/docs/migrations/migrating-to-v5","draft":false,"unlisted":false,"editUrl":"https://github.com/ouweiya/zustand-zh/blob/master/docs/migrations/migrating-to-v5.md","tags":[],"version":"current","frontMatter":{"title":"\u5982\u4f55\u4ece v4 \u8fc1\u79fb\u5230 v5","nav":23},"sidebar":"tutorialSidebar","previous":{"title":"\u8fc1\u79fb\u5230v4","permalink":"/zustand-zh/docs/migrations/migrating-to-v4"},"next":{"title":"createStore","permalink":"/zustand-zh/docs/apis/create-store"}}');var a=t(4848),r=t(8453);const l={title:"\u5982\u4f55\u4ece v4 \u8fc1\u79fb\u5230 v5",nav:23},c="\u5982\u4f55\u4ece v4 \u8fc1\u79fb\u5230 v5",i={},o=[{value:"v5 \u7684\u53d8\u5316",id:"v5-\u7684\u53d8\u5316",level:2},{value:"\u8fc1\u79fb\u6307\u5357",id:"\u8fc1\u79fb\u6307\u5357",level:2},{value:"\u4f7f\u7528\u81ea\u5b9a\u4e49\u76f8\u7b49\u51fd\u6570\u5982 <code>shallow</code>",id:"\u4f7f\u7528\u81ea\u5b9a\u4e49\u76f8\u7b49\u51fd\u6570\u5982-shallow",level:3},{value:"\u9700\u8981\u7a33\u5b9a\u7684\u9009\u62e9\u5668\u8f93\u51fa",id:"\u9700\u8981\u7a33\u5b9a\u7684\u9009\u62e9\u5668\u8f93\u51fa",level:3},{value:"\u5f53 setState \u7684 replace \u6807\u5fd7\u8bbe\u7f6e\u65f6\uff0c\u66f4\u4e25\u683c\u7684\u7c7b\u578b\uff08\u4ec5\u9650 Typescript\uff09",id:"\u5f53-setstate-\u7684-replace-\u6807\u5fd7\u8bbe\u7f6e\u65f6\u66f4\u4e25\u683c\u7684\u7c7b\u578b\u4ec5\u9650-typescript",level:3},{value:"\u5904\u7406\u52a8\u6001 <code>replace</code> \u6807\u5fd7",id:"\u5904\u7406\u52a8\u6001-replace-\u6807\u5fd7",level:4},{value:"\u6301\u4e45\u5316\u4e2d\u95f4\u4ef6\u4e0d\u518d\u5728\u5b58\u50a8\u521b\u5efa\u65f6\u5b58\u50a8\u9879\u76ee",id:"\u6301\u4e45\u5316\u4e2d\u95f4\u4ef6\u4e0d\u518d\u5728\u5b58\u50a8\u521b\u5efa\u65f6\u5b58\u50a8\u9879\u76ee",level:4},{value:"\u94fe\u63a5",id:"\u94fe\u63a5",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"\u5982\u4f55\u4ece-v4-\u8fc1\u79fb\u5230-v5",children:"\u5982\u4f55\u4ece v4 \u8fc1\u79fb\u5230 v5"})}),"\n",(0,a.jsx)(n.p,{children:"\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae\u5728\u8fc1\u79fb\u5230 v5 \u4e4b\u524d\u66f4\u65b0\u5230 v4 \u7684\u6700\u65b0\u7248\u672c\u3002\u5b83\u4f1a\u663e\u793a\u6240\u6709\u5f03\u7528\u8b66\u544a\uff0c\u800c\u4e0d\u4f1a\u7834\u574f\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u3002"}),"\n",(0,a.jsx)(n.h2,{id:"v5-\u7684\u53d8\u5316",children:"v5 \u7684\u53d8\u5316"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u5220\u9664\u9ed8\u8ba4\u5bfc\u51fa"}),"\n",(0,a.jsx)(n.li,{children:"\u5220\u9664\u5f03\u7528\u529f\u80fd"}),"\n",(0,a.jsx)(n.li,{children:"\u5c06 React 18 \u8bbe\u4e3a\u6700\u4f4e\u8981\u6c42\u7248\u672c"}),"\n",(0,a.jsxs)(n.li,{children:["\u5c06 use-sync-external-store \u8bbe\u4e3a\u5bf9\u7b49\u4f9d\u8d56\u9879\uff08\u5728 ",(0,a.jsx)(n.code,{children:"zustand/traditional"})," \u4e2d\u7528\u4e8e ",(0,a.jsx)(n.code,{children:"createWithEqualityFn"})," \u548c ",(0,a.jsx)(n.code,{children:"useStoreWithEqualityFn"}),"\uff09"]}),"\n",(0,a.jsx)(n.li,{children:"\u5c06 TypeScript 4.5 \u8bbe\u4e3a\u6700\u4f4e\u8981\u6c42\u7248\u672c"}),"\n",(0,a.jsx)(n.li,{children:"\u5220\u9664 UMD/SystemJS \u652f\u6301"}),"\n",(0,a.jsx)(n.li,{children:"\u5728 package.json \u4e2d\u7ec4\u7ec7\u5165\u53e3\u70b9"}),"\n",(0,a.jsx)(n.li,{children:"\u5220\u9664 ES5 \u652f\u6301"}),"\n",(0,a.jsx)(n.li,{children:"\u5f53 setState \u7684 replace \u6807\u5fd7\u8bbe\u7f6e\u65f6\uff0c\u66f4\u4e25\u683c\u7684\u7c7b\u578b"}),"\n",(0,a.jsx)(n.li,{children:"\u6301\u4e45\u5316\u4e2d\u95f4\u4ef6\u884c\u4e3a\u53d8\u5316"}),"\n",(0,a.jsx)(n.li,{children:"\u5176\u4ed6\u5c0f\u6539\u8fdb\uff08\u6280\u672f\u4e0a\u662f\u91cd\u5927\u53d8\u5316\uff09"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u8fc1\u79fb\u6307\u5357",children:"\u8fc1\u79fb\u6307\u5357"}),"\n",(0,a.jsxs)(n.h3,{id:"\u4f7f\u7528\u81ea\u5b9a\u4e49\u76f8\u7b49\u51fd\u6570\u5982-shallow",children:["\u4f7f\u7528\u81ea\u5b9a\u4e49\u76f8\u7b49\u51fd\u6570\u5982 ",(0,a.jsx)(n.code,{children:"shallow"})]}),"\n",(0,a.jsxs)(n.p,{children:["v5 \u4e2d\u7684 ",(0,a.jsx)(n.code,{children:"create"})," \u51fd\u6570\u4e0d\u652f\u6301\u81ea\u5b9a\u4e49\u76f8\u7b49\u51fd\u6570\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u5982\u679c\u60a8\u4f7f\u7528\u81ea\u5b9a\u4e49\u76f8\u7b49\u51fd\u6570\u5982 ",(0,a.jsx)(n.code,{children:"shallow"}),"\uff0c\u6700\u7b80\u5355\u7684\u8fc1\u79fb\u65b9\u6cd5\u662f\u4f7f\u7528 ",(0,a.jsx)(n.code,{children:"createWithEqualityFn"}),"\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// v4\nimport { create } from 'zustand'\nimport { shallow } from 'zustand/shallow'\n\nconst useCountStore = create((set) => ({\n  count: 0,\n  text: 'hello',\n  // ...existing code...\n}))\n\nconst Component = () => {\n  const { count, text } = useCountStore(\n    (state) => ({\n      count: state.count,\n      text: state.text,\n    }),\n    shallow,\n  )\n  // ...existing code...\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u8fd9\u53ef\u4ee5\u5728 v5 \u4e2d\u4f7f\u7528 ",(0,a.jsx)(n.code,{children:"createWithEqualityFn"})," \u5b8c\u6210\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npm install use-sync-external-store\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// v5\nimport { createWithEqualityFn as create } from 'zustand/traditional'\n\n// \u5176\u4f59\u90e8\u5206\u4e0e v4 \u76f8\u540c\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u6216\u8005\uff0c\u5bf9\u4e8e ",(0,a.jsx)(n.code,{children:"shallow"})," \u7528\u4f8b\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 ",(0,a.jsx)(n.code,{children:"useShallow"})," \u94a9\u5b50\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// v5\nimport { create } from 'zustand'\nimport { useShallow } from 'zustand/shallow'\n\nconst useCountStore = create((set) => ({\n  count: 0,\n  text: 'hello',\n  // ...existing code...\n}))\n\nconst Component = () => {\n  const { count, text } = useCountStore(\n    useShallow((state) => ({\n      count: state.count,\n      text: state.text,\n    })),\n  )\n  // ...existing code...\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u9700\u8981\u7a33\u5b9a\u7684\u9009\u62e9\u5668\u8f93\u51fa",children:"\u9700\u8981\u7a33\u5b9a\u7684\u9009\u62e9\u5668\u8f93\u51fa"}),"\n",(0,a.jsx)(n.p,{children:"v5 \u4e2d\u6709\u4e00\u4e2a\u884c\u4e3a\u53d8\u5316\uff0c\u4ee5\u5339\u914d React \u7684\u9ed8\u8ba4\u884c\u4e3a\u3002\u5982\u679c\u9009\u62e9\u5668\u8fd4\u56de\u4e00\u4e2a\u65b0\u5f15\u7528\uff0c\u5b83\u53ef\u80fd\u4f1a\u5bfc\u81f4\u65e0\u9650\u5faa\u73af\u3002"}),"\n",(0,a.jsx)(n.p,{children:"\u4f8b\u5982\uff0c\u8fd9\u53ef\u80fd\u4f1a\u5bfc\u81f4\u65e0\u9650\u5faa\u73af\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// v4\nconst [searchValue, setSearchValue] = useStore((state) => [\n  state.searchValue,\n  state.setSearchValue,\n])\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u9519\u8bef\u6d88\u606f\u5c06\u7c7b\u4f3c\u4e8e\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-plaintext",children:"Uncaught Error: Maximum update depth exceeded. This can happen when a component repeatedly calls setState inside componentWillUpdate or componentDidUpdate. React limits the number of nested updates to prevent infinite loops.\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u8981\u4fee\u590d\u5b83\uff0c\u8bf7\u4f7f\u7528 ",(0,a.jsx)(n.code,{children:"useShallow"})," \u94a9\u5b50\uff0c\u5b83\u5c06\u8fd4\u56de\u4e00\u4e2a\u7a33\u5b9a\u7684\u5f15\u7528\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// v5\nimport { useShallow } from 'zustand/shallow'\n\nconst [searchValue, setSearchValue] = useStore(\n  useShallow((state) => [state.searchValue, state.setSearchValue]),\n)\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u662f\u53e6\u4e00\u4e2a\u53ef\u80fd\u5bfc\u81f4\u65e0\u9650\u5faa\u73af\u7684\u793a\u4f8b\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// v4\nconst action = useMainStore((state) => {\n  return state.action ?? () => {}\n})\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u8981\u4fee\u590d\u5b83\uff0c\u8bf7\u786e\u4fdd\u9009\u62e9\u5668\u51fd\u6570\u8fd4\u56de\u4e00\u4e2a\u7a33\u5b9a\u7684\u5f15\u7528\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// v5\n\nconst FALLBACK_ACTION = () => {}\n\nconst action = useMainStore((state) => {\n  return state.action ?? FALLBACK_ACTION\n})\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u6216\u8005\uff0c\u5982\u679c\u60a8\u9700\u8981 v4 \u884c\u4e3a\uff0c",(0,a.jsx)(n.code,{children:"createWithEqualityFn"})," \u53ef\u4ee5\u505a\u5230\u3002"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// v5\nimport { createWithEqualityFn as create } from 'zustand/traditional'\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u5f53-setstate-\u7684-replace-\u6807\u5fd7\u8bbe\u7f6e\u65f6\u66f4\u4e25\u683c\u7684\u7c7b\u578b\u4ec5\u9650-typescript",children:"\u5f53 setState \u7684 replace \u6807\u5fd7\u8bbe\u7f6e\u65f6\uff0c\u66f4\u4e25\u683c\u7684\u7c7b\u578b\uff08\u4ec5\u9650 Typescript\uff09"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-diff",children:"- setState:\n-   (partial: T | Partial<T> | ((state: T) => T | Partial<T>), replace?: boolean |\xa0undefined) => void;\n+ setState:\n+   (partial: T | Partial<T> | ((state: T) => T | Partial<T>), replace?: false) => void;\n+   (state: T | ((state: T) => T), replace: true) => void;\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u5982\u679c\u60a8\u4e0d\u4f7f\u7528 ",(0,a.jsx)(n.code,{children:"replace"})," \u6807\u5fd7\uff0c\u5219\u4e0d\u9700\u8981\u8fc1\u79fb\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u5982\u679c\u60a8\u4f7f\u7528 ",(0,a.jsx)(n.code,{children:"replace"})," \u6807\u5fd7\u5e76\u5c06\u5176\u8bbe\u7f6e\u4e3a ",(0,a.jsx)(n.code,{children:"true"}),"\uff0c\u5219\u5fc5\u987b\u63d0\u4f9b\u5b8c\u6574\u7684\u72b6\u6001\u5bf9\u8c61\u3002\u6b64\u66f4\u6539\u786e\u4fdd ",(0,a.jsx)(n.code,{children:"store.setState({}, true)"}),"\uff08\u5bfc\u81f4\u65e0\u6548\u72b6\u6001\uff09\u4e0d\u518d\u88ab\u89c6\u4e3a\u6709\u6548\u3002"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"\u793a\u4f8b\uff1a"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"// \u90e8\u5206\u72b6\u6001\u66f4\u65b0\uff08\u6709\u6548\uff09\nstore.setState({ key: 'value' })\n\n// \u5b8c\u6574\u72b6\u6001\u66ff\u6362\uff08\u6709\u6548\uff09\nstore.setState({ key: 'value' }, true)\n\n// \u4e0d\u5b8c\u6574\u72b6\u6001\u66ff\u6362\uff08\u65e0\u6548\uff09\nstore.setState({}, true) // \u9519\u8bef\n"})}),"\n",(0,a.jsxs)(n.h4,{id:"\u5904\u7406\u52a8\u6001-replace-\u6807\u5fd7",children:["\u5904\u7406\u52a8\u6001 ",(0,a.jsx)(n.code,{children:"replace"})," \u6807\u5fd7"]}),"\n",(0,a.jsxs)(n.p,{children:["\u5982\u679c ",(0,a.jsx)(n.code,{children:"replace"})," \u6807\u5fd7\u7684\u503c\u662f\u52a8\u6001\u7684\u5e76\u5728\u8fd0\u884c\u65f6\u786e\u5b9a\uff0c\u60a8\u53ef\u80fd\u4f1a\u9047\u5230\u95ee\u9898\u3002\u8981\u5904\u7406\u6b64\u95ee\u9898\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 ",(0,a.jsx)(n.code,{children:"setState"})," \u51fd\u6570\u7684\u53c2\u6570\u6ce8\u91ca ",(0,a.jsx)(n.code,{children:"replace"})," \u53c2\u6570\u6765\u4f7f\u7528\u53d8\u901a\u65b9\u6cd5\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"const replaceFlag = Math.random() > 0.5\nconst args = [{ bears: 5 }, replaceFlag] as Parameters<\n  typeof useBearStore.setState\n>\nstore.setState(...args)\n"})}),"\n",(0,a.jsx)(n.h4,{id:"\u6301\u4e45\u5316\u4e2d\u95f4\u4ef6\u4e0d\u518d\u5728\u5b58\u50a8\u521b\u5efa\u65f6\u5b58\u50a8\u9879\u76ee",children:"\u6301\u4e45\u5316\u4e2d\u95f4\u4ef6\u4e0d\u518d\u5728\u5b58\u50a8\u521b\u5efa\u65f6\u5b58\u50a8\u9879\u76ee"}),"\n",(0,a.jsxs)(n.p,{children:["\u4ee5\u524d\uff0c",(0,a.jsx)(n.code,{children:"persist"})," \u4e2d\u95f4\u4ef6\u5728\u5b58\u50a8\u521b\u5efa\u671f\u95f4\u5b58\u50a8\u521d\u59cb\u72b6\u6001\u3002\u6b64\u884c\u4e3a\u5728 v5\uff08\u548c v4.5.5\uff09\u4e2d\u5df2\u88ab\u5220\u9664\u3002"]}),"\n",(0,a.jsx)(n.p,{children:"\u4f8b\u5982\uff0c\u5728\u4ee5\u4e0b\u4ee3\u7801\u4e2d\uff0c\u521d\u59cb\u72b6\u6001\u5b58\u50a8\u5728\u5b58\u50a8\u4e2d\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// v4\nimport { create } from 'zustand'\nimport { persist } from 'zustand/middleware'\n\nconst useCountStore = create(\n  persist(\n    () => ({\n      count: Math.floor(Math.random() * 1000),\n    }),\n    {\n      name: 'count',\n    },\n  ),\n)\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u5728 v5 \u4e2d\uff0c\u4e0d\u518d\u662f\u8fd9\u79cd\u60c5\u51b5\uff0c\u60a8\u9700\u8981\u5728\u5b58\u50a8\u521b\u5efa\u540e\u663e\u5f0f\u8bbe\u7f6e\u72b6\u6001\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"// v5\nimport { create } from 'zustand'\nimport { persist } from 'zustand/middleware'\n\nconst useCountStore = create(\n  persist(\n    () => ({\n      count: 0,\n    }),\n    {\n      name: 'count',\n    },\n  ),\n)\nuseCountStore.setState({\n  count: Math.floor(Math.random() * 1000),\n})\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u94fe\u63a5",children:"\u94fe\u63a5"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/pmndrs/zustand/pull/2138",children:"https://github.com/pmndrs/zustand/pull/2138"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/pmndrs/zustand/pull/2580",children:"https://github.com/pmndrs/zustand/pull/2580"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>c});var s=t(6540);const a={},r=s.createContext(a);function l(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);